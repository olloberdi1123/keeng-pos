<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="manifest.json">
    <title>KEENG MARKET SaaS</title>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Xato:', err)); });
        }
    </script>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --blue: #2563eb; --green: #10b981; --red: #ef4444; --orange: #f59e0b; --dark: #1e293b; --bg: #f8fafc; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; background: var(--bg); overflow: hidden; position: fixed; width: 100%; height: 100%; overscroll-behavior-y: none; }
        .screen, .tab-content { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 80px; }
        .screen { display: none; animation: fadeIn 0.3s; } .screen.active { display: block; }
        .tab-content { display: none !important; padding: 15px; padding-bottom: 85px; } .tab-content.active-tab { display: block !important; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.97); }
        .btn-blue { background: var(--blue); } .btn-green { background: var(--green); } .btn-red { background: var(--red); } .btn-orange { background: var(--orange); } .btn-dark { background: var(--dark); } .btn-outline { background: transparent; border: 2px solid #ddd; color: #555; } .btn-loc { background: #0ea5e9; color: white; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 16px; outline: none; background: white; }
        .qty-btn { width: 35px; height: 35px; border-radius: 8px; border: none; background: #e2e8f0; font-weight: bold; font-size: 18px; }
        .qty-input { width: 60px; height: 35px; text-align: center; border: 2px solid var(--blue); border-radius: 8px; font-weight: bold; margin: 0; padding: 0; font-size: 16px; }
        .price-input { width: 90px; padding: 8px; text-align: center; border: 1px solid #cbd5e1; border-radius: 8px; font-weight: bold; color: var(--blue); }
        .card { background: white; padding: 15px; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .flex-between { display: flex; justify-content: space-between; align-items: center; } .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .cat-tag { background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .cat-card { background: white; padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; cursor: pointer; } .cat-card i { font-size: 30px; color: var(--blue); margin-bottom: 10px; }
        .top-bar { position: sticky; top: 0; background: rgba(255,255,255,0.95); padding: 10px 15px; z-index: 100; border-bottom: 1px solid #e2e8f0; backdrop-filter: blur(8px); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: white; display: flex; border-top: 1px solid #eee; z-index: 999; padding-bottom: safe-area-inset-bottom; }
        .nav-btn { flex: 1; background: none; border: none; color: #94a3b8; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; position: relative; } .nav-btn.active { color: var(--blue); font-weight: bold; }
        .badge { position: absolute; top: -5px; right: 0; background: var(--red); color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; display: none; z-index: 1002; border: 2px solid white; }
        
        .tarif-card { border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; } .tarif-card:hover { border-color: #cbd5e1; } .tarif-card.selected { border-color: var(--blue); background: #eff6ff; }
        .nav-btn.locked { opacity: 0.5; position: relative; } .nav-btn.locked::after { content: '\f023'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: 5px; right: 10px; font-size: 12px; color: var(--red); }
        .cart-panel { position: fixed; bottom: 65px; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); transform: translateY(120%); transition: transform 0.3s; z-index: 900; display: flex; flex-direction: column; max-height: 85vh; overflow-y: auto; } .cart-panel.open { transform: translateY(0); }
        .float-btn { position: fixed; bottom: 85px; right: 20px; width: 60px; height: 60px; background: var(--blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 10px 25px rgba(37,99,235,0.4); z-index: 800; font-size: 24px; }
        #cart-badge, #client-cart-badge { position: absolute; top: 0; right: 0; background: var(--red); font-size: 12px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; display: none; }
        #screen-login { display: none; align-items: center; justify-content: center; background: var(--dark); color: white; } #screen-login.active { display: flex; } .login-box { width: 90%; max-width: 450px; text-align: center; }
        .stat-card { text-align: center; padding: 20px; color: white; border-radius: 16px; margin-bottom: 10px; } .warehouse-summary { background: linear-gradient(135deg, #0d9488, #14b8a6); color: white; padding: 15px; border-radius: 16px; margin-bottom: 15px; text-align: center; } .report-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; } .report-table th { background: #f1f5f9; text-align: left; padding: 8px; border-bottom: 2px solid #ddd; } .report-table td { padding: 8px; border-bottom: 1px solid #eee; } .tag-naqd { color: var(--green); font-weight: bold; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(3px); } .modal-box { background: white; width: 92%; max-width: 400px; padding: 20px; border-radius: 20px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; color: var(--dark); } .custom-alert-box { text-align: center; } .custom-alert-icon { font-size: 50px; color: var(--blue); margin-bottom: 15px; } .custom-alert-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; } .receipt-style { font-family: 'Courier New', Courier, monospace; background: #fff; padding: 15px; border: 1px dashed #ccc; margin-bottom: 15px; text-align: left; cursor: pointer; color: black; }

        #printable-area { display: none; }
        @media print {
            @page { margin: 0; size: auto; }
            html, body { margin: 0 !important; padding: 0 !important; background: white !important; overflow: visible !important; height: auto !important; position: static !important; }
            .screen, .modal, .btn, .float-btn, .top-bar, .bottom-nav { display: none !important; }
            #printable-area { display: block !important; position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding-left: 5mm; padding-right: 5mm; padding-bottom: 80px; box-sizing: border-box; }
            #printable-area * { visibility: visible !important; font-family: sans-serif; color: black !important; font-weight: 900; }
            .chk-header { text-align: center; font-size: 18px; text-transform: uppercase; margin-bottom: 5px; border-bottom: 3px solid black; padding-bottom: 5px; } .chk-sub { text-align: center; font-size: 12px; margin-bottom: 10px; font-weight: bold; } .chk-item { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px; border-bottom: 1px dashed #000; padding-bottom: 2px; } .chk-total { font-size: 16px; margin-top: 15px; margin-bottom: 15px; border-top: 3px solid black; border-bottom: 3px solid black; padding: 8px 0; display: flex; justify-content: space-between; font-weight: 900; } .chk-footer { text-align: center; font-size: 11px; margin-top: 15px; line-height: 1.4; } .chk-emoji { font-size: 20px; display: block; margin-top: 8px; }
        }
    </style>
</head>
<body>
    <div id="printable-area"></div>

    <div id="screen-login" class="screen active">
        <div class="login-box" style="background: white; padding: 20px; border-radius: 20px; color: var(--dark);">
            <h1 style="font-size: 2rem; margin-bottom: 5px; color: var(--dark);">KEENG<span style="color:var(--blue)">MARKET</span></h1>
            <p style="color: #666; margin-bottom: 20px;">SaaS Savdo Tizimi</p>

            <div style="display: flex; background: #f1f5f9; border-radius: 12px; margin-bottom: 20px; padding: 5px;">
                <button id="tab-btn-login" class="btn btn-blue" style="margin:0; box-shadow:none;" onclick="toggleAuthMode('login')">KIRISH</button>
                <button id="tab-btn-register" class="btn btn-outline" style="margin:0; border:none; color:#666;" onclick="toggleAuthMode('register')">YANGI DO'KON</button>
            </div>

            <div id="form-login">
                <input type="tel" id="login-phone" placeholder="Telefon raqam (901234567)">
                <input type="password" id="login-pass" placeholder="Parol">
                <button class="btn btn-blue" onclick="saasLogin()">TIZIMGA KIRISH</button>
            </div>

            <div id="form-register" style="display: none; text-align: left; max-height: 50vh; overflow-y: auto; padding-right: 5px;">
                <input type="text" id="reg-name" placeholder="Do'kon nomi (masalan: M-Oil)">
                <input type="tel" id="reg-phone" placeholder="Telefon raqami (Login uchun)">
                <input type="password" id="reg-pass" placeholder="Yangi parol o'ylab toping">
                
                <h4 style="margin: 15px 0 10px 0;">Tarifni tanlang:</h4>
                <div class="tarif-card" onclick="selectTarif('mini', this)"><div class="flex-between"><b>MINI</b><span style="color: var(--blue); font-weight: bold;">70,000 so'm/oy</span></div><small style="color: #666;">Kassa, Ombor, Nasiya, Sozlamalar</small></div>
                <div class="tarif-card" onclick="selectTarif('standart', this)"><div class="flex-between"><b>STANDART</b><span style="color: var(--blue); font-weight: bold;">90,000 so'm/oy</span></div><small style="color: #666;">+ Hisobot bo'limi</small></div>
                <div class="tarif-card" onclick="selectTarif('premium', this)"><div class="flex-between"><b>PREMIUM</b><span style="color: var(--blue); font-weight: bold;">140,000 so'm/oy</span></div><small style="color: #666;">+ Online buyurtmalar (Telegram orqali)</small></div>
                <input type="hidden" id="selected-tarif" value="">
                <button class="btn btn-green" style="margin-top: 15px;" onclick="saasRegister()">RO'YXATDAN O'TISH</button>
            </div>
            
            <div style="margin: 20px 0; border-top: 1px dashed #ccc;"></div>
            <button class="btn btn-outline" onclick="myAlert('Mijozlarga o\'z do\'koningizning Mini App havolasini yuboring (Sozlamalar bo\'limida mavjud).')">MIJOZ (BUYURTMA BERISH)</button>
        </div>
    </div>

    <div id="screen-admin" class="screen">
        <div id="tab-kassa" class="tab-content active-tab">
            <div class="top-bar"><div class="grid-scan" style="display: flex; gap: 8px;"><input type="text" id="search-inp" placeholder="Qidirish..." oninput="renderKassa()" style="margin:0;"><button class="btn btn-dark" style="width: auto; margin:0;" onclick="startScanner('kassa')"><i class="fas fa-barcode"></i></button></div></div>
            <div id="kassa-list" style="margin-top: 15px;"></div>
            <div class="float-btn" onclick="toggleCart()"><i class="fas fa-shopping-cart"></i><span id="cart-badge">0</span></div>
            <div id="cart-panel" class="cart-panel">
                <div class="cart-header" style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><h3>Savat</h3><button class="btn btn-red small" style="width:auto; padding:5px 15px;" onclick="toggleCart()"><i class="fas fa-chevron-down"></i></button></div>
                <div id="cart-items" style="overflow-y:auto; flex-grow:1; padding:15px;"></div>
                <div style="padding: 15px; border-top: 1px solid #eee; background: white;">
                    <div class="flex-between" style="margin-bottom: 10px; font-size: 18px;"><span>Jami:</span><b id="cart-sum-total">0 so'm</b></div>
                    <div class="grid-2"><button class="btn btn-green" onclick="checkoutConfirmation('naqd')">NAQD</button><button class="btn btn-blue" onclick="checkoutConfirmation('plastik')">PLASTIK</button></div>
                    <button class="btn btn-orange" onclick="checkoutConfirmation('nasiya')">NASIYA (QARZGA)</button>
                </div>
            </div>
        </div>

        <div id="tab-ombor" class="tab-content">
            <div class="card">
                <h3>Tovar Qo'shish</h3><input type="hidden" id="p-id">
                <div style="display: flex; gap: 5px;"><input type="text" id="p-code" placeholder="Kodlar"><button class="btn btn-dark" style="width: auto; margin-bottom: 10px;" onclick="startScanner('ombor')"><i class="fas fa-barcode"></i></button></div>
                <input type="text" id="p-cat" placeholder="Kategoriya" list="cat-list"><datalist id="cat-list"></datalist>
                <input type="text" id="p-name" placeholder="Nomi">
                <div class="grid-2"><select id="p-unit"><option value="dona">Dona</option><option value="kg">Kg</option></select><input type="number" id="p-qty" placeholder="Soni"></div>
                <div class="grid-2"><input type="number" id="p-buy" placeholder="Kelish"><input type="number" id="p-sell" placeholder="Sotish"></div>
                <div class="grid-2"><button class="btn btn-blue" onclick="saveProduct()">SAQLASH</button><button class="btn btn-outline" onclick="clearForm()">TOZALASH</button></div>
            </div>
            <div id="stock-summary-container"></div><input type="text" id="stock-search" placeholder="Qidirish..." oninput="renderStock()" style="margin-bottom:10px;"><div id="stock-list"></div>
        </div>

        <div id="tab-nasiya" class="tab-content">
            <div class="card" style="background: #fff7ed; border: 1px solid #fdba74;"><span style="color: #c2410c;">Faqat Qarzlar jami:</span><h2 id="total-debt-sum" style="margin: 5px 0; color: #9a3412;">0 so'm</h2></div>
            <input type="text" id="debt-search" placeholder="Qidirish..." oninput="renderDebts()">
            <div id="debt-list"></div>
        </div>

        <div id="tab-online" class="tab-content">
            <h3>Yangi Buyurtmalar <span id="online-count-title" class="badge" style="position:static; display:inline-block;">0</span></h3>
            <div id="online-orders-list"></div>
        </div>

        <div id="tab-hisobot" class="tab-content">
            <div class="stat-card" style="background: var(--blue);"><small>KUNLIK SOF FOYDA</small><h1 id="stat-profit" style="margin: 5px 0;">0 so'm</h1></div>
            <div class="grid-2"><div class="card center"><small>Naqd</small><h3 id="stat-naqd" style="margin:5px 0; color:var(--green);">0</h3></div><div class="card center"><small>Plastik</small><h3 id="stat-plastik" style="margin:5px 0; color:var(--blue);">0</h3></div></div>
            <button class="btn btn-outline" onclick="showTodayDetails()">BUGUNGI SAVDOLAR</button>
            <div class="card"><h3>Kunni Yopish</h3><input type="text" id="close-comment" placeholder="Izoh"><button class="btn btn-red" onclick="closeDay()">KUNNI YOPISH</button></div>
            <div class="grid-2"><button class="btn btn-orange" onclick="closePeriod('week')">HAFTALIK</button><button class="btn btn-dark" onclick="closePeriod('month')">OYLIK</button></div>
            <h3>Arxivlar</h3>
            <div class="grid-2" style="margin-bottom: 15px;"><button class="btn btn-outline" onclick="renderArchive('day')">Kunlik</button><button class="btn btn-outline" onclick="renderArchive('week')">Haftalik</button><button class="btn btn-outline" onclick="renderArchive('month')">Oylik</button></div><div id="archive-list"></div>
        </div>

        <div id="tab-sozlamalar" class="tab-content">
            <div class="card">
                <h3>Do'kon Sozlamalari</h3><p style="font-size:12px; color:#666;">Bu ma'lumotlar chekda chiqadi</p>
                <input type="text" id="set-dokon-nomi" placeholder="Do'kon nomi">
                <input type="tel" id="set-telefon" placeholder="Bog'lanish uchun telefon">
                <input type="text" id="set-chek-footer" placeholder="Chek tagidagi yozuv">
                
                <div style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px;">
                    <h4 style="margin-top:0; color:var(--blue);"><i class="fab fa-telegram"></i> Telegram Mini App</h4>
                    <p style="font-size:12px; color:#666;">BotFather'dan bot oching va Web App URL qismiga ushbu sizning shaxsiy havolangizni joylashtiring:</p>
                    <input type="text" id="mini-app-link" readonly style="background:#f1f5f9; font-size:13px; cursor:copy;" onclick="this.select(); document.execCommand('copy'); myAlert('Havola nusxalandi!');">
                </div>
                <div style="margin-top: 10px;">
                    <p style="font-size:12px; color:#666; margin-bottom:5px;">Qo'shimcha SMS borishi uchun (Ixtiyoriy):</p>
                    <input type="text" id="set-tg-token" placeholder="Bot Token">
                    <input type="text" id="set-tg-chat" placeholder="Chat ID">
                </div>
                <button class="btn btn-green" onclick="saveSozlamalar()">SAQLASH</button>
            </div>

            <div class="card" style="background: #fff; border: 1px solid #ddd;">
                <h3 style="margin-top:0"><i class="fab fa-bluetooth-b" style="color: var(--blue);"></i> Bluetooth Printer</h3>
                <p style="font-size:12px; color:#666;">Qurilmani brauzer orqali to'g'ridan-to'g'ri ulash.</p>
                <button class="btn btn-dark" onclick="connectBluetooth()"><i class="fas fa-search"></i> Qurilma qidirish</button>
            </div>
            
            <div class="card" style="background: #eff6ff; border: 1px solid var(--blue);">
                <h3 style="margin-top:0"><i class="fas fa-headset"></i> Support (Yordam)</h3>
                <p style="font-size:14px; margin-bottom: 15px;">To'lov va tariflar bo'yicha adminga murojaat qiling.<br><br><i class="fas fa-phone-alt"></i> Tel: <b>+998 93 453 11 23</b><br><i class="fab fa-telegram"></i> Telegram: <b>@mamadaliyevv_o</b></p>
                <a href="https://t.me/mamadaliyevv_o" target="_blank" class="btn btn-blue" style="text-decoration: none;">ADMINGA YOZISH</a>
            </div>
            <button class="btn btn-red" onclick="saasLogout()" style="margin-top:20px;"><i class="fas fa-sign-out-alt"></i> Tizimdan chiqish</button>
        </div>

        <nav class="bottom-nav">
            <button class="nav-btn active" onclick="switchTab('kassa', this)"><i class="fas fa-cash-register"></i> Kassa</button>
            <button class="nav-btn" onclick="switchTab('ombor', this)"><i class="fas fa-box"></i> Ombor</button>
            <button class="nav-btn" onclick="switchTab('nasiya', this)"><i class="fas fa-user-clock"></i> Nasiya</button>
            <button class="nav-btn" id="nav-btn-online" onclick="switchTab('online', this)"><i class="fas fa-globe"></i> Online <span id="nav-badge" class="badge">0</span></button>
            <button class="nav-btn" id="nav-btn-hisobot" onclick="switchTab('hisobot', this)"><i class="fas fa-chart-pie"></i> Hisobot</button>
            <button class="nav-btn" onclick="switchTab('sozlamalar', this)"><i class="fas fa-cog"></i> Sozlama</button>
        </nav>
    </div>

    <div id="screen-client" class="screen">
        <div class="top-bar flex-between"><b id="client-title">MARKET</b><button class="btn btn-outline small" id="client-back-btn" style="width:auto; display:none;" onclick="renderClientCategories()"><i class="fas fa-arrow-left"></i> Orqaga</button></div>
        <div id="client-view-container" class="grid-2" style="padding: 15px; padding-bottom: 80px;"></div>
        <div class="float-btn" onclick="toggleClientCart()" style="bottom: 30px;"><i class="fas fa-shopping-bag"></i><span id="client-cart-badge">0</span></div>
        <div id="client-cart-panel" class="cart-panel"><div class="cart-header"><h3 style="margin:0">Buyurtmangiz</h3><button class="btn btn-red small" style="width:auto; padding:5px 15px;" onclick="toggleClientCart()"><i class="fas fa-chevron-down"></i></button></div><div id="client-cart-items" class="cart-body" style="padding:15px;"></div><div style="padding: 15px; border-top: 1px solid #eee; background: white;"><div class="flex-between" style="margin-bottom:10px;"><b>Jami:</b><b id="client-cart-total">0 so'm</b></div><input type="text" id="client-name" placeholder="Ismingiz"><input type="tel" id="client-phone" placeholder="Telefon (901234567)" inputmode="numeric" pattern="[0-9]*"><button class="btn btn-loc" onclick="getLocation()">üìç Joylashuv</button><div id="loc-status" class="loc-status" style="display:none; color:green; margin-bottom:10px;">Joylashuv olindi ‚úÖ</div><button class="btn btn-green" onclick="submitOrderFinal()">BUYURTMA BERISH</button></div></div>
    </div>

    <div id="modal-expired" class="modal" style="z-index: 99999; background: rgba(30, 41, 59, 0.98);">
        <div class="modal-box" style="text-align:center; padding: 30px 20px;">
            <i class="fas fa-lock" style="font-size:50px; color:var(--red); margin-bottom:15px;"></i>
            <h2 style="color:var(--dark); margin-top: 0;">Kechirasiz, hurmatli mijoz!</h2>
            <p style="color: #666; font-size: 15px;">Sizning oylik to'lov muddatingiz o'z nihoyasiga yetdi yoki profilingiz bloklangan. Dasturdan foydalanishni davom ettirish uchun to'lovni amalga oshiring.</p>
            <div style="background:#f8fafc; padding:15px; border-radius:12px; border: 1px dashed var(--blue); margin: 20px 0; text-align: left;">
                <b style="color: var(--blue);">To'lov va ma'lumot uchun:</b><br><br>
                <i class="fas fa-phone-alt"></i> Tel: <b>+998 93 453 11 23</b><br>
                <i class="fab fa-telegram"></i> Telegram: <b>@mamadaliyevv_o</b>
            </div>
            <a href="https://t.me/mamadaliyevv_o" target="_blank" class="btn btn-blue" style="text-decoration: none;">Adminga yozish</a>
            <button class="btn btn-outline" onclick="saasLogout()">Tizimdan chiqish</button>
        </div>
    </div>

    <div id="custom-alert" class="modal"><div class="modal-box custom-alert-box"><div class="custom-alert-icon"><i class="fas fa-info-circle"></i></div><div id="custom-alert-msg" class="custom-alert-title"></div><button class="btn btn-blue" onclick="closeModal('custom-alert')">Tushunarli</button></div></div>
    <div id="custom-confirm" class="modal"><div class="modal-box custom-alert-box"><div class="custom-alert-icon" style="color:var(--orange)"><i class="fas fa-question-circle"></i></div><div id="custom-confirm-msg" class="custom-alert-title"></div><div class="grid-2"><button id="confirm-yes-btn" class="btn btn-green">HA</button><button class="btn btn-red" onclick="closeModal('custom-confirm')">YO'Q</button></div></div></div>
    
    <div id="modal-admin-check" class="modal">
        <div class="modal-box">
            <div class="flex-between" style="margin-bottom: 10px;">
                <h3 style="margin:0;">Tasdiqlash</h3>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-outline small" style="width:auto; margin:0; padding:5px 10px;" onclick="printReceipt()"><i class="fas fa-print"></i> Oddiy</button>
                    <button class="btn btn-outline small" style="width:auto; margin:0; padding:5px 10px; border-color:var(--blue); color:var(--blue);" onclick="shareToIPrint()"><i class="fas fa-share-nodes"></i> iPrint</button>
                </div>
            </div>
            <div id="admin-check-content" class="receipt-style"></div>
            
            <button class="btn btn-green" onclick="completeCheckout()">SOTISH</button>
            <button class="btn btn-red" onclick="closeModal('modal-admin-check')">BEKOR</button>
        </div>
    </div>
    
    <div id="modal-client-check" class="modal"><div class="modal-box"><h3>Tasdiqlash</h3><div id="client-check-content" class="receipt-style"></div><button class="btn btn-green" onclick="submitOrderFinal()">TASDIQLASH</button><button class="btn btn-red" onclick="closeModal('modal-client-check')">BEKOR</button></div></div>
    <div id="modal-debt-create" class="modal"><div class="modal-box"><h3>Nasiya Yozish</h3><p>Jami: <b id="debt-modal-total">0</b></p><input type="text" id="debt-customer-name" placeholder="Ism"><input type="text" id="debt-customer-phone" placeholder="Tel"><button class="btn btn-green" onclick="confirmDebt()">TASDIQLASH</button><button class="btn btn-red" onclick="closeModal('modal-debt-create')">BEKOR</button></div></div>
    
    <div id="modal-debt-info" class="modal">
        <div class="modal-box" style="height:80vh;">
            <div class="flex-between">
                <h3 id="debt-info-name">Mijoz</h3>
                <button onclick="closeModal('modal-debt-info')" style="background:none; border:none; font-size:20px;">‚úï</button>
            </div>
            <h2 id="debt-info-balance" style="text-align:center; margin-top:5px;">0</h2>
            <div style="background:#f1f5f9; padding:10px; border-radius:10px; flex-grow:1; overflow-y:auto; margin-bottom:10px;">
                <div id="debt-history-list"></div>
            </div>
            <input type="number" id="debt-pay-amount" placeholder="Summani kiriting">
            <div class="grid-2">
                <button class="btn btn-green" onclick="payDebt('kirim')">PUL OLISH</button>
                <button class="btn btn-red" onclick="payDebt('chiqim')">PUL BERISH</button>
            </div>
        </div>
    </div>
    
    <div id="modal-archive-detail" class="modal"><div class="modal-box" style="height:90vh;"><div class="flex-between"><h3 id="archive-title" style="margin:0">Tafsilotlar</h3><button onclick="closeModal('modal-archive-detail')" style="background:none; border:none; font-size:24px;">√ó</button></div><div id="archive-detail-content" style="flex-grow:1; overflow-y:auto; margin-top:10px;"></div><button class="btn btn-red" style="margin-top:10px;" onclick="closeModal('modal-archive-detail')">YOPISH</button></div></div>
    <div id="scanner-modal" class="modal" style="background:black;"><div style="width:100%; height:100%; display:flex; flex-direction:column;"><div id="reader" style="width:100%; flex-grow:1;"></div><button class="btn btn-red big-btn" style="margin:20px;" onclick="stopScanner()">YOPISH</button></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyA8F47YRcEPTIwyI7AjSeqXIyddFpz8orU", authDomain: "keeng-market.firebaseapp.com", databaseURL: "https://keeng-market-default-rtdb.firebaseio.com", projectId: "keeng-market", storageBucket: "keeng-market.firebasestorage.app", messagingSenderId: "688523074873", appId: "1:688523074873:web:016b69f98a238bd19d5ce8" };
        firebase.initializeApp(firebaseConfig); const db = firebase.database();

        let currentTarif = null, currentUserPhone = null;
        let dokonSozlamalar = { dokon_nomi: "Do'kon", telefon: "", chek_footer: "Xaridingiz uchun rahmat!", obuna_tugash_sanasi: "", status: "faol" };
        let DB = [], CART = [], clientCart = [], DEBTS = [], ORDERS = [];
        let SESSION = { sales: [], date: null }, ARCHIVES = { daily: [], weekly: [], monthly: [] };
        let html5QrCode = null, clientLoc = null, activeClientCat = null, confirmCallback = null, scanLock = false, tempType = null;
        
        const orderSound = new Audio('https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg');
        let prevOrderCount = -1;

        const urlParams = new URLSearchParams(window.location.search);
        const shopParam = urlParams.get('shop');

        window.onload = () => {
            window.addEventListener('online', syncToCloud);
            window.addEventListener('offline', () => myAlert("Diqqat! Siz oflayn rejimdasiz."));
            if (!navigator.onLine) { setTimeout(() => myAlert("Diqqat! Siz oflayn rejimdasiz."), 1000); }

            if (shopParam) {
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.expand) window.Telegram.WebApp.expand();
                openClientModeFromUrl(shopParam);
            } else { checkLocalLogin(); }
        };

        function openClientModeFromUrl(shopId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-client').classList.add('active');
            db.ref("saas_dokonlar/" + shopId).on("value", snap => {
                if(snap.exists()) {
                    const data = snap.val(); DB = data.DB || []; dokonSozlamalar = data.sozlamalar || {};
                    document.getElementById('client-title').innerText = dokonSozlamalar.dokon_nomi || "MARKET";
                    if(!activeClientCat) renderClientCategories(); else renderClientProducts(activeClientCat);
                } else { document.getElementById('client-view-container').innerHTML = "<h3 style='text-align:center;width:100%;margin-top:50px;'>Do'kon topilmadi!</h3>"; }
            });
        }

        function checkLocalLogin() {
            const savedPhone = localStorage.getItem('saas_current_phone');
            if (savedPhone) {
                currentUserPhone = savedPhone; loadFromLocal(savedPhone); checkSubscription();
                document.getElementById('screen-login').classList.remove('active'); document.getElementById('screen-admin').classList.add('active');
                const myUrl = window.location.href.split('?')[0]; document.getElementById('mini-app-link').value = myUrl + "?shop=" + savedPhone;
                applyTariffLocks(); refreshUI();
                if (navigator.onLine) { startListeningTenant(currentUserPhone); syncToCloud(); }
            }
        }
        function loadFromLocal(phone) { const localData = localStorage.getItem('saas_data_' + phone); if (localData) { const d = JSON.parse(localData); dokonSozlamalar = d.sozlamalar || dokonSozlamalar; currentTarif = dokonSozlamalar.tarif; DB = d.DB || []; DEBTS = d.DEBTS || []; ORDERS = d.ORDERS || []; SESSION = d.SESSION || { sales: [], date: new Date().toLocaleDateString() }; ARCHIVES = d.ARCHIVES || { daily: [], weekly: [], monthly: [] }; } }
        function saveToLocal() { if (!currentUserPhone) return; const dataToSave = { sozlamalar: dokonSozlamalar, DB: DB, DEBTS: DEBTS, ORDERS: ORDERS, SESSION: SESSION, ARCHIVES: ARCHIVES }; localStorage.setItem('saas_data_' + currentUserPhone, JSON.stringify(dataToSave)); localStorage.setItem('saas_needs_sync', 'true'); }
        function saveToCloud() { 
            if (!currentUserPhone) return; saveToLocal(); 
            if (navigator.onLine) { 
                db.ref("saas_dokonlar/" + currentUserPhone).update({ DB: DB, DEBTS: DEBTS, SESSION: SESSION, ARCHIVES: ARCHIVES, ORDERS: ORDERS, "sozlamalar/dokon_nomi": dokonSozlamalar.dokon_nomi || "", "sozlamalar/telefon": dokonSozlamalar.telefon || "", "sozlamalar/chek_footer": dokonSozlamalar.chek_footer || "", "sozlamalar/tg_bot_token": dokonSozlamalar.tg_bot_token || "", "sozlamalar/tg_chat_id": dokonSozlamalar.tg_chat_id || "" }).then(() => { localStorage.removeItem('saas_needs_sync'); }).catch(e => console.log("Saqlash xatosi")); 
            } 
        }
        function syncToCloud() { if (localStorage.getItem('saas_needs_sync') === 'true' && currentUserPhone) saveToCloud(); }
        
        function startListeningTenant(phone) {
            db.ref("saas_dokonlar/" + phone).on("value", snap => {
                if (snap.exists()) {
                    const d = snap.val(); dokonSozlamalar = d.sozlamalar || dokonSozlamalar; checkSubscription(); 
                    if (localStorage.getItem('saas_needs_sync') !== 'true') {
                        DB = d.DB || []; DEBTS = d.DEBTS || []; let rawOrders = d.ORDERS || []; ORDERS = Array.isArray(rawOrders) ? rawOrders : Object.values(rawOrders);
                        if (prevOrderCount !== -1 && ORDERS.length > prevOrderCount) { orderSound.play().catch(e=>console.log(e)); if(navigator.vibrate) navigator.vibrate([200,100,200]); }
                        prevOrderCount = ORDERS.length;
                        SESSION = d.SESSION || { sales: [], date: new Date().toLocaleDateString() }; ARCHIVES = d.ARCHIVES || { daily: [], weekly: [], monthly: [] };
                        saveToLocal(); refreshUI();
                    }
                }
            });
        }

        function toggleAuthMode(mode) { if(mode === 'login') { document.getElementById('form-login').style.display = 'block'; document.getElementById('form-register').style.display = 'none'; document.getElementById('tab-btn-login').className = 'btn btn-blue'; document.getElementById('tab-btn-register').className = 'btn btn-outline'; document.getElementById('tab-btn-register').style.border = 'none'; } else { document.getElementById('form-login').style.display = 'none'; document.getElementById('form-register').style.display = 'block'; document.getElementById('tab-btn-register').className = 'btn btn-blue'; document.getElementById('tab-btn-login').className = 'btn btn-outline'; document.getElementById('tab-btn-login').style.border = 'none'; } }
        function selectTarif(tarif, el) { document.querySelectorAll('.tarif-card').forEach(c => c.classList.remove('selected')); el.classList.add('selected'); document.getElementById('selected-tarif').value = tarif; }
        
        function saasRegister() {
            if (!navigator.onLine) return myAlert("Internet kerak!");
            const name = document.getElementById('reg-name').value, phone = document.getElementById('reg-phone').value, pass = document.getElementById('reg-pass').value, tarif = document.getElementById('selected-tarif').value;
            if(!name || !phone || !pass) return myAlert("Maydonlarni to'ldiring!"); if(!tarif) return myAlert("Tarif tanlang!");
            db.ref("saas_dokonlar/" + phone).once("value", snap => {
                if(snap.exists()) return myAlert("Bu raqam band.");
                let exp = new Date(); exp.setDate(exp.getDate() + 30); 
                const newStore = { sozlamalar: { dokon_nomi: name, telefon: phone, parol: pass, tarif: tarif, obuna_tugash_sanasi: exp.toISOString().split('T')[0], ro_yxatdan_sana: new Date().toLocaleDateString(), status: "faol", chek_footer: "Xaridingiz uchun rahmat! üòä", tg_bot_token: "", tg_chat_id: "" }, DB: [], DEBTS: [], ORDERS: [], SESSION: { sales: [], date: new Date().toLocaleDateString() }, ARCHIVES: { daily: [], weekly: [], monthly: [] } };
                db.ref("saas_dokonlar/" + phone).set(newStore).then(() => { myAlert("Muvaffaqiyatli! 30 kun muddat berildi."); toggleAuthMode('login'); document.getElementById('login-phone').value = phone; document.getElementById('login-pass').value = pass; });
            });
        }

        function saasLogin() {
            const phone = document.getElementById('login-phone').value, pass = document.getElementById('login-pass').value;
            if(!phone || !pass) return myAlert("Kiritilmadi!");
            if (!navigator.onLine) {
                const localData = localStorage.getItem('saas_data_' + phone);
                if (localData) { const parsed = JSON.parse(localData); if (parsed.sozlamalar.parol === pass) { localStorage.setItem('saas_current_phone', phone); checkLocalLogin(); return myAlert("Oflayn rejim"); } else return myAlert("Parol xato"); } 
                else return myAlert("Internet yo'q!");
            }
            db.ref("saas_dokonlar/" + phone).once("value", snap => {
                if(!snap.exists()) return myAlert("Topilmadi!"); const data = snap.val();
                if(data.sozlamalar.parol !== pass) return myAlert("Parol xato!");
                if(data.sozlamalar.status === 'bloklangan') return myAlert("Profilingiz admin tomonidan bloklangan!");
                currentUserPhone = phone; currentTarif = data.sozlamalar.tarif; localStorage.setItem('saas_current_phone', phone);
                dokonSozlamalar = data.sozlamalar; DB = data.DB || []; DEBTS = data.DEBTS || []; let rawOrders = data.ORDERS || []; ORDERS = Array.isArray(rawOrders) ? rawOrders : Object.values(rawOrders); prevOrderCount = ORDERS.length;
                SESSION = data.SESSION || { sales: [], date: new Date().toLocaleDateString() }; ARCHIVES = data.ARCHIVES || { daily: [], weekly: [], monthly: [] }; saveToLocal();
                document.getElementById('set-dokon-nomi').value = dokonSozlamalar.dokon_nomi || ""; document.getElementById('set-telefon').value = dokonSozlamalar.telefon || ""; document.getElementById('set-chek-footer').value = dokonSozlamalar.chek_footer || ""; document.getElementById('set-tg-token').value = dokonSozlamalar.tg_bot_token || ""; document.getElementById('set-tg-chat').value = dokonSozlamalar.tg_chat_id || "";
                const myUrl = window.location.href.split('?')[0]; document.getElementById('mini-app-link').value = myUrl + "?shop=" + phone;
                startListeningTenant(phone); document.getElementById('screen-login').classList.remove('active'); document.getElementById('screen-admin').classList.add('active'); applyTariffLocks(); refreshUI();
            });
        }
        function saasLogout() { myConfirm("Chiqishni xohlaysizmi?", () => { localStorage.removeItem('saas_current_phone'); localStorage.removeItem('saas_data_' + currentUserPhone); location.reload(); }); }
        function saveSozlamalar() { dokonSozlamalar.dokon_nomi = document.getElementById('set-dokon-nomi').value; dokonSozlamalar.telefon = document.getElementById('set-telefon').value; dokonSozlamalar.chek_footer = document.getElementById('set-chek-footer').value; dokonSozlamalar.tg_bot_token = document.getElementById('set-tg-token').value.trim(); dokonSozlamalar.tg_chat_id = document.getElementById('set-tg-chat').value.trim(); saveToCloud(); myAlert("Sozlamalar saqlandi!"); }

        async function connectBluetooth() { try { const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true }); myAlert(device.name + " ulandi! (Chek oynasidagi 'iPrint' orqali chiqaring)"); } catch(e) { myAlert("Bekor qilindi yoki ishlamaydi."); } }

        function checkSubscription() {
            if (!dokonSozlamalar || !dokonSozlamalar.obuna_tugash_sanasi) return;
            const expDate = new Date(dokonSozlamalar.obuna_tugash_sanasi); const today = new Date();
            if (dokonSozlamalar.status === 'bloklangan' || today > expDate) { document.getElementById('modal-expired').style.display = 'flex'; } else { document.getElementById('modal-expired').style.display = 'none'; }
        }

        function switchTab(t, b) {
            if (currentTarif === 'mini' && (t === 'hisobot' || t === 'online')) return myAlert("Bu tarif mavjud emas. Supportga yozing.");
            if (currentTarif === 'standart' && t === 'online') return myAlert("Bu tarif mavjud emas. Supportga yozing.");
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active-tab')); document.getElementById('tab-' + t).classList.add('active-tab'); document.querySelectorAll('.nav-btn').forEach(n => n.classList.remove('active')); b.classList.add('active'); if (t === 'hisobot') renderStats();
        }
        function applyTariffLocks() { document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('locked')); if (currentTarif === 'mini') { document.getElementById('nav-btn-hisobot').classList.add('locked'); document.getElementById('nav-btn-online').classList.add('locked'); } else if (currentTarif === 'standart') { document.getElementById('nav-btn-online').classList.add('locked'); } }
        function refreshUI() { if (document.getElementById('screen-admin').classList.contains('active')) { renderKassa(); renderStock(); renderStats(); renderDebts(); updateCartUI(); renderOnlineOrders(); checkSubscription(); } if (document.getElementById('screen-client').classList.contains('active')) { if (activeClientCat) renderClientProducts(activeClientCat); else renderClientCategories(); updateClientCartUI(); } const b = document.getElementById('nav-badge'); const c = ORDERS ? ORDERS.length : 0; if (c > 0) { b.style.display = 'block'; b.innerText = c; } else b.style.display = 'none'; }
        function myAlert(msg) { document.getElementById('custom-alert-msg').innerText = msg; document.getElementById('custom-alert').style.display = 'flex'; } function myConfirm(msg, yesCb) { document.getElementById('custom-confirm-msg').innerText = msg; document.getElementById('custom-confirm').style.display = 'flex'; confirmCallback = yesCb; } document.getElementById('confirm-yes-btn').onclick = function() { if (confirmCallback) confirmCallback(); closeModal('custom-confirm'); }; function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // KASSA
        function renderKassa() { const s = document.getElementById('search-inp').value.toLowerCase(); document.getElementById('kassa-list').innerHTML = DB.filter(p => { const codes = p.code ? p.code.split(',').map(c => c.trim().toLowerCase()) : []; return p.name.toLowerCase().includes(s) || p.cat.toLowerCase().includes(s) || codes.some(c => c.includes(s)); }).map(p => `<div class="card flex-between" onclick="addToCart(${p.id})"><div><span class="cat-tag">${p.cat}</span><div style="font-weight:bold;">${p.name}</div><small style="color:#666">Ombor: ${p.qty}</small></div><b>${p.sell.toLocaleString()}</b></div>`).join(''); }
        function addToCart(id) { const p = DB.find(x => x.id === id); if (!p || p.qty <= 0) return myAlert("Tugagan!"); const ex = CART.find(x => x.id === id); if (ex) ex.cartQty++; else CART.push({ ...p, cartQty: 1, customPrice: p.sell }); updateCartUI(); }
        function updateCartUI() { let t = 0, q = 0; document.getElementById('cart-items').innerHTML = CART.map((i, idx) => { t += i.cartQty * i.customPrice; q += i.cartQty; return `<div class="cart-item" style="margin-bottom:10px;"><div class="flex-between"><b>${i.name}</b><button style="color:red;border:none;background:none;font-size:18px;" onclick="removeFromCart(${idx})">üóë</button></div><div class="flex-between" style="margin-top:5px;"><div class="cart-controls" style="display:flex;gap:5px;"><button class="qty-btn" onclick="changeQty(${idx},-1)">-</button><input type="number" class="qty-input" value="${i.cartQty}" onchange="updateCartQtyManual(${idx},this.value)"><button class="qty-btn" onclick="changeQty(${idx},1)">+</button></div><input type="number" class="price-input" value="${i.customPrice}" onchange="changePrice(${idx},this.value)"></div></div>`; }).join(''); document.getElementById('cart-sum-total').innerText = t.toLocaleString() + " so'm"; const b = document.getElementById('cart-badge'); if (q > 0) { b.style.display = 'flex'; b.innerText = q; } else b.style.display = 'none'; }
        function changeQty(i, d) { if (d > 0 && CART[i].cartQty >= DB.find(x => x.id == CART[i].id).qty) return myAlert("Yetarli!"); CART[i].cartQty += d; if (CART[i].cartQty <= 0) CART.splice(i, 1); updateCartUI(); } function updateCartQtyManual(i, v) { let q = parseFloat(v); const o = DB.find(x => x.id == CART[i].id); if (q > o.qty) { myAlert("Yetarli!"); q = o.qty; } if (q <= 0) { myConfirm("O'chirasizmi?", () => { CART.splice(i, 1); updateCartUI(); }); } else { CART[i].cartQty = q; updateCartUI(); } } function changePrice(i, v) { CART[i].customPrice = parseFloat(v) || 0; updateCartUI(); } function removeFromCart(i) { CART.splice(i, 1); updateCartUI(); } function toggleCart() { document.getElementById('cart-panel').classList.toggle('open'); }

        // CHECKOUT & iPRINT RASMGA OLISH
        function checkoutConfirmation(type) { if (!CART.length) return myAlert("Savat bo'sh!"); if (type === 'nasiya') return openDebtModal(); tempType = type; const total = CART.reduce((a, b) => a + b.cartQty * b.customPrice, 0); const dName = dokonSozlamalar.dokon_nomi || "KEENG MARKET"; const dFoot = dokonSozlamalar.chek_footer || "Xaridingiz uchun rahmat!"; let h = `<div style="text-align:center;"><b>${dName}</b><br><small>Sana: ${new Date().toLocaleString()}</small><br><small>To'lov: ${type.toUpperCase()}</small></div><hr>`; CART.forEach(c => { h += `<div style="display:flex; justify-content:space-between;"><span>${c.name}</span><span>${c.cartQty}x${(c.customPrice).toLocaleString()}</span></div>`; }); h += `<hr><div style="display:flex; justify-content:space-between; font-weight:bold; font-size:18px;"><span>JAMI:</span><span>${total.toLocaleString()}</span></div>`; document.getElementById('admin-check-content').innerHTML = h; let ph = `<div class="chk-header">${dName}</div><div class="chk-sub">Do'kon cheki<br>${new Date().toLocaleString()}</div>`; CART.forEach(c => { ph += `<div class="chk-item"><span style="flex-grow:1">${c.name}</span><span style="white-space:nowrap; margin-left:10px;">${c.cartQty}x${c.customPrice}</span></div>`; }); ph += `<div class="chk-total"><span>ITOGO:</span><span>${total.toLocaleString()}</span></div><div class="chk-footer">${dFoot}<br><span class="chk-emoji">üòä</span></div>`; document.getElementById('printable-area').innerHTML = ph; document.getElementById('modal-admin-check').style.display = 'flex'; }
        
        function shareToIPrint() {
            const checkDiv = document.getElementById('admin-check-content');
            const oldBorder = checkDiv.style.border;
            checkDiv.style.border = "none";
            checkDiv.style.padding = "20px";
            checkDiv.style.background = "#ffffff";
            checkDiv.style.color = "#000000";

            html2canvas(checkDiv, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
                checkDiv.style.border = oldBorder;
                checkDiv.style.padding = "15px";
                canvas.toBlob(blob => {
                    const file = new File([blob], "chek.png", { type: "image/png" });
                    if (navigator.share) {
                        navigator.share({ title: 'Xarid cheki', files: [file] }).catch(e => { myAlert("Ulashish bekor qilindi yoki xatolik."); });
                    } else {
                        myAlert("Qurilmangiz rasm ulashishni qo'llab-quvvatlamaydi.");
                    }
                }, "image/png");
            }).catch(e => { myAlert("Rasmga olishda xatolik yuz berdi!"); });
        }

        function completeCheckout() { const total = CART.reduce((a, b) => a + b.cartQty * b.customPrice, 0); processSale(tempType, total); closeModal('modal-admin-check'); } function printReceipt() { window.print(); }
        
        function processSale(type, total) { 
            const p = CART.reduce((a, b) => a + (b.customPrice - (parseFloat(b.buy) || 0)) * b.cartQty, 0); 
            CART.forEach(c => { const x = DB.find(i => i.id === c.id); if (x) x.qty -= c.cartQty; }); 
            SESSION.sales.push({ id: Date.now(), time: new Date().toLocaleTimeString(), items: [...CART], total, profit: p, type }); 
            CART = []; 
            updateCartUI(); 
            toggleCart(); 
            saveToCloud(); 
            renderStats(); 
            renderKassa(); 
            renderStock(); 
            myAlert("Tasdiqlandi!"); 
        }

        // OMBOR
        function saveProduct() { const n = document.getElementById('p-name').value; const s = parseFloat(document.getElementById('p-sell').value); const id = document.getElementById('p-id').value; if (!n || !s) return myAlert("Xato!"); const i = { id: id ? parseInt(id) : Date.now(), code: document.getElementById('p-code').value, cat: document.getElementById('p-cat').value || 'Boshqa', name: n, unit: document.getElementById('p-unit').value, qty: parseFloat(document.getElementById('p-qty').value) || 0, buy: parseFloat(document.getElementById('p-buy').value) || 0, sell: s }; if (id) DB[DB.findIndex(x => x.id == id)] = i; else DB.push(i); clearForm(); renderStock(); saveToCloud(); } function renderStock() { const s = document.getElementById('stock-search').value.toLowerCase(); const b = DB.reduce((a, x) => a + x.qty * (parseFloat(x.buy) || 0), 0); const sl = DB.reduce((a, x) => a + x.qty * (parseFloat(x.sell) || 0), 0); document.getElementById('stock-summary-container').innerHTML = `<div class="warehouse-summary"><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><div><small>KELISH KAPI</small><h2>${b.toLocaleString()}</h2></div><div style="border-left:1px solid #fff3"><small>SOTUV KAPI</small><h2>${sl.toLocaleString()}</h2></div></div></div>`; document.getElementById('stock-list').innerHTML = DB.filter(p => { const codes = p.code ? p.code.split(',').map(c => c.trim().toLowerCase()) : []; return p.name.toLowerCase().includes(s) || codes.some(c => c.includes(s)); }).sort((x, y) => { if (x.qty <= 0 && y.qty > 0) return -1; if (x.qty > 0 && y.qty <= 0) return 1; return y.id - x.id; }).map(p => { const isOut = p.qty <= 0; const style = isOut ? 'background: #fee2e2; border: 1px solid #ef4444;' : ''; const qtyText = isOut ? '<b style="color:#ef4444">TUGAGAN (0)</b>' : `${p.qty} ${p.unit}`; return `<div class="card flex-between" style="${style}"><div><span class="cat-tag">${p.cat}</span><div><b>${p.name}</b></div><small>${qtyText}</small></div><button class="btn btn-blue small" style="width:auto" onclick="editP(${p.id})">‚úé</button></div>`; }).join(''); document.getElementById('cat-list').innerHTML = [...new Set(DB.map(p => p.cat))].map(c => `<option value="${c}">`).join(''); } function editP(id) { const p = DB.find(x => x.id == id); Object.keys(p).forEach(k => { if (document.getElementById('p-' + k)) document.getElementById('p-' + k).value = p[k]; }); window.scrollTo(0, 0); } function clearForm() { document.querySelectorAll('#tab-ombor input').forEach(i => i.value = ''); document.getElementById('p-id').value = ''; }
        
        // ONLINE
        function renderOnlineOrders() { const c = ORDERS ? ORDERS.length : 0; document.getElementById('online-count-title').innerText = c; document.getElementById('online-orders-list').innerHTML = ORDERS.map(o => { let m = o.loc ? `<a href="https://www.google.com/maps?q=${o.loc.lat},${o.loc.lng}" target="_blank" class="btn btn-outline" style="margin-top:5px; text-decoration:none;">üìç Joylashuv</a>` : ''; return `<div class="card"><div class="flex-between"><b>${o.client}</b><small>${o.date}</small></div><div><a href="tel:${o.phone}">${o.phone}</a></div><div style="border-top:1px solid #eee; margin:5px 0; padding:5px 0; font-size:13px;">${o.items.map(i => `${i.name} x${i.qty}`).join('<br>')}</div><div class="flex-between"><b>Jami: ${o.total.toLocaleString()}</b></div>${m}<div class="grid-2" style="margin-top:10px;"><button class="btn btn-green small" onclick="acceptOrder(${o.id})">QABUL</button><button class="btn btn-red small" onclick="rejectOrder(${o.id})">BEKOR</button></div></div>`; }).join(''); } 
        function acceptOrder(id) { myConfirm("Qabul?", () => { const o = ORDERS.find(x => x.id === id); o.items.forEach(i => { const p = DB.find(x => x.id === i.id); if (p) p.qty -= i.qty; }); const pr = o.items.reduce((a, b) => a + (b.sell - (parseFloat(b.buy) || 0)) * b.qty, 0); SESSION.sales.push({ id: Date.now(), time: new Date().toLocaleTimeString(), items: o.items, total: o.total, profit: pr, type: 'naqd', note: `Online: ${o.client}` }); ORDERS = ORDERS.filter(x => x.id !== id); saveToCloud(); refreshUI(); myAlert("Qabul qilindi!"); }); } 
        function rejectOrder(id) { myConfirm("O'chirasizmi?", () => { ORDERS = ORDERS.filter(x => x.id !== id); saveToCloud(); renderOnlineOrders(); }); }
        
        // NASIYA (YANGILANGAN MANTIQ)
        function openDebtModal() { if (!CART.length) return myAlert("Savat bo'sh!"); document.getElementById('debt-modal-total').innerText = CART.reduce((a, b) => a + b.cartQty * b.customPrice, 0).toLocaleString(); document.getElementById('modal-debt-create').style.display = 'flex'; } 
        function confirmDebt() { const n = document.getElementById('debt-customer-name').value; if (!n) return myAlert("Ism kerak!"); const t = CART.reduce((a, b) => a + b.cartQty * b.customPrice, 0); const p = CART.reduce((a, b) => a + (b.customPrice - (parseFloat(b.buy) || 0)) * b.cartQty, 0); CART.forEach(c => { const x = DB.find(i => i.id === c.id); if (x) x.qty -= c.cartQty; }); let d = DEBTS.find(x => x.name.toLowerCase() === n.toLowerCase()); if (!d) { d = { id: Date.now(), name: n, phone: document.getElementById('debt-customer-phone').value, balance: 0, history: [] }; DEBTS.push(d); } d.balance += t; d.history.push({ date: new Date().toLocaleString(), type: 'Nasiya xarid', amount: t, items: [...CART] }); SESSION.sales.push({ id: Date.now(), time: new Date().toLocaleTimeString(), items: [...CART], total: t, profit: p, type: 'nasiya' }); CART = []; updateCartUI(); closeModal('modal-debt-create'); toggleCart(); saveToCloud(); renderStats(); renderKassa(); renderStock(); renderDebts(); myAlert("Nasiya yozildi!"); } 
        
        function renderDebts() { 
            const s = document.getElementById('debt-search').value.toLowerCase(); 
            // 0 ga teng bo'lmagan HAMMANI ko'rsatish
            document.getElementById('debt-list').innerHTML = DEBTS.filter(d => d.name.toLowerCase().includes(s) && d.balance !== 0).map(d => {
                let balText = d.balance > 0 ? `<b style="color:var(--red)">Qarz: ${d.balance.toLocaleString()}</b>` : `<b style="color:var(--green)">Haqdor: ${Math.abs(d.balance).toLocaleString()}</b>`;
                return `<div class="card flex-between" onclick="showDebtInfo(${d.id})"><div><b>${d.name}</b><br><small>${d.phone || ''}</small></div>${balText}</div>`;
            }).join(''); 
            // Jami qarz summasi faqat qarzga botganlardan olinadi
            document.getElementById('total-debt-sum').innerText = DEBTS.filter(d => d.balance > 0).reduce((a, b) => a + b.balance, 0).toLocaleString() + " so'm"; 
        } 
        
        let curDebtId = null; 
        function showDebtInfo(id) { 
            curDebtId = id; 
            const d = DEBTS.find(x => x.id == id); 
            document.getElementById('debt-info-name').innerText = d.name; 
            const balEl = document.getElementById('debt-info-balance');
            
            if (d.balance > 0) {
                balEl.innerText = "Qarz: " + d.balance.toLocaleString();
                balEl.style.color = "var(--red)";
            } else {
                balEl.innerText = "Haqdor: " + Math.abs(d.balance).toLocaleString();
                balEl.style.color = "var(--green)";
            }

            document.getElementById('debt-history-list').innerHTML = d.history.slice().reverse().map(h => `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #ddd;padding:5px 0;"><div>${h.date}<br><small>${h.type}</small></div><b style="color:${h.type === 'Pul olindi' ? 'green' : (h.type === 'Nasiya xarid' ? 'red' : 'var(--orange)')}">${h.amount.toLocaleString()}</b></div>`).join(''); 
            document.getElementById('modal-debt-info').style.display = 'flex'; 
        } 
        
        function payDebt(type) { 
            const a = parseFloat(document.getElementById('debt-pay-amount').value); 
            if (!a || a <= 0) return myAlert("Xato summa!"); 
            const d = DEBTS.find(x => x.id == curDebtId); 
            
            if (type === 'kirim') {
                d.balance -= a; 
                d.history.push({ date: new Date().toLocaleString(), type: 'Pul olindi', amount: a, items: [] }); 
                SESSION.sales.push({ id: Date.now(), time: new Date().toLocaleTimeString(), items: [], total: a, profit: 0, type: 'naqd', note: 'Qarz uzildi: ' + d.name }); 
            } else {
                d.balance += a; 
                d.history.push({ date: new Date().toLocaleString(), type: 'Pul berildi', amount: a, items: [] }); 
                SESSION.sales.push({ id: Date.now(), time: new Date().toLocaleTimeString(), items: [], total: -a, profit: 0, type: 'naqd', note: 'Haqdorga berildi: ' + d.name }); 
            }

            document.getElementById('debt-pay-amount').value = ''; 
            closeModal('modal-debt-info'); 
            saveToCloud(); renderStats(); renderDebts(); 
            myAlert("Saqlandi!"); 
        }

        // HISOBOT
        function renderStats() { if (!SESSION.sales) SESSION.sales = []; document.getElementById('stat-naqd').innerText = SESSION.sales.filter(x => x.type == 'naqd').reduce((a, b) => a + b.total, 0).toLocaleString(); document.getElementById('stat-plastik').innerText = SESSION.sales.filter(x => x.type == 'plastik').reduce((a, b) => a + b.total, 0).toLocaleString(); document.getElementById('stat-profit').innerText = SESSION.sales.reduce((a, b) => a + (b.profit || 0), 0).toLocaleString() + " so'm"; } function closeDay() { myConfirm("Yopasizmi?", () => { const r = { date: new Date().toLocaleString(), totalNaqd: SESSION.sales.filter(x => x.type == 'naqd').reduce((a, b) => a + b.total, 0), totalPlastik: SESSION.sales.filter(x => x.type == 'plastik').reduce((a, b) => a + b.total, 0), totalNasiya: SESSION.sales.filter(x => x.type == 'nasiya').reduce((a, b) => a + b.total, 0), profit: SESSION.sales.reduce((a, b) => a + (b.profit || 0), 0), details: JSON.parse(JSON.stringify(SESSION.sales)), comment: document.getElementById('close-comment').value }; if (!ARCHIVES.daily) ARCHIVES.daily = []; ARCHIVES.daily.push(r); SESSION.sales = []; SESSION.date = new Date().toLocaleDateString(); saveToCloud(); renderStats(); myAlert("Kun yopildi!"); }); } function closePeriod(t) { myConfirm("Saqlaysizmi?", () => { const r = { date: new Date().toLocaleString(), type: t, summaryProfit: (ARCHIVES.daily || []).slice(-7).reduce((a, b) => a + b.profit, 0) }; if (!ARCHIVES[t == 'week' ? 'weekly' : 'monthly']) ARCHIVES[t == 'week' ? 'weekly' : 'monthly'] = []; ARCHIVES[t == 'week' ? 'weekly' : 'monthly'].push(r); saveToCloud(); myAlert("Saqlandi!"); }); } function renderArchive(t) { const d = (t == 'day' ? ARCHIVES.daily : (t == 'week' ? ARCHIVES.weekly : ARCHIVES.monthly)) || []; document.getElementById('archive-list').innerHTML = d.slice().reverse().map((i, idx) => { let total = 0; if (t === 'day') total = (i.totalNaqd || 0) + (i.totalPlastik || 0) + (i.totalNasiya || 0); let displayHtml = t === 'day' ? `<div style="text-align:right;"><div>Savdo: <b>${total.toLocaleString()}</b></div><div style="font-size:12px; color:var(--green)">Foyda: ${(i.profit || 0).toLocaleString()}</div></div>` : `<b style="color:var(--green)">${(i.profit || i.summaryProfit).toLocaleString()}</b>`; return `<div class="card flex-between" onclick="showArchiveDetails('${t}',${d.length - 1 - idx})"><b>${i.date}</b>${displayHtml}</div>`; }).join(''); } function showTodayDetails() { buildAndShowTable("Bugungi", SESSION.sales, true); } function showArchiveDetails(t, idx) { if (t !== 'day') return myAlert("Faqat kunlikda bor."); buildAndShowTable("Arxiv: " + ARCHIVES.daily[idx].date, ARCHIVES.daily[idx].details); } function buildAndShowTable(ti, tr, isT=false) { document.getElementById('archive-title').innerText = ti; if (!tr || !tr.length) { document.getElementById('archive-detail-content').innerHTML = "<p>Bo'sh</p>"; document.getElementById('modal-archive-detail').style.display = 'flex'; return; } let h = `<table class="report-table"><thead><tr><th>Vaqt</th><th>Tovar</th><th>Summa</th>${isT ? '<th></th>' : ''}</tr></thead><tbody>`; [...tr].reverse().forEach(s => { let l = s.items && s.items.length ? s.items.map(i => `${i.name} x${i.cartQty}`).join('<br>') : (s.note ? `<i>${s.note}</i>` : '-'); let b = isT ? `<td><button onclick="returnSale(${s.id})" style="background:red;color:white;border:none;padding:5px;border-radius:5px;font-size:10px;">VOZVRAT</button></td>` : ''; h += `<tr><td>${s.time}</td><td>${l}</td><td><b>${s.total.toLocaleString()}</b><br><span class="tag-${s.type}">${s.type.toUpperCase()}</span></td>${b}</tr>`; }); h += `</tbody></table>`; document.getElementById('archive-detail-content').innerHTML = h; document.getElementById('modal-archive-detail').style.display = 'flex'; } function returnSale(id) { myConfirm("Vozvrat?", () => { const idx = SESSION.sales.findIndex(s => s.id === id); if (idx === -1) return; const s = SESSION.sales[idx]; if (s.items) s.items.forEach(i => { const d = DB.find(x => x.id === i.id); if (d) d.qty += i.cartQty; }); SESSION.sales.splice(idx, 1); saveToCloud(); refreshUI(); closeModal('modal-archive-detail'); myAlert("Vozvrat qilindi!"); }); }

        // MIJOZ
        function renderClientCategories() { activeClientCat = null; document.getElementById('client-title').innerText = "KATEGORIYALAR"; document.getElementById('client-back-btn').style.display = 'none'; const c = [...new Set(DB.map(p => p.cat))]; document.getElementById('client-view-container').innerHTML = c.map(x => `<div class="cat-card" onclick="renderClientProducts('${x}')"><i class="fas fa-folder"></i><b>${x}</b></div>`).join(''); } function renderClientProducts(cat) { activeClientCat = cat; document.getElementById('client-title').innerText = cat; document.getElementById('client-back-btn').style.display = 'block'; document.getElementById('client-view-container').innerHTML = DB.filter(p => p.cat === cat).map(p => `<div class="card flex-between"><div><b>${p.name}</b><br><span style="color:var(--blue)">${p.sell.toLocaleString()} so'm</span></div>${p.qty > 0 ? `<button class="btn btn-green small" style="width:auto" onclick="addToClientCart(${p.id})">Qo'shish +</button>` : `<span style="color:red">Tugagan</span>`}</div>`).join(''); } function addToClientCart(id) { const p = DB.find(x => x.id === id); const ex = clientCart.find(x => x.id === id); if (ex) ex.qty++; else clientCart.push({ ...p, qty: 1 }); updateClientCartUI(); } function updateClientCartUI() { const b = document.getElementById('client-cart-badge'); const q = clientCart.length; if (q > 0) { b.style.display = 'flex'; b.innerText = q; } else b.style.display = 'none'; let t = 0; document.getElementById('client-cart-items').innerHTML = clientCart.map((c, i) => { t += c.qty * c.sell; return `<div class="card flex-between" style="padding:10px; margin-bottom:5px;"><div><b>${c.name}</b><br>${c.sell}</div><div style="display:flex; align-items:center; gap:10px;"><button class="qty-btn" onclick="changeClientQty(${i},-1)">-</button><input type="number" class="qty-input" value="${c.qty}" onchange="updateClientQtyManual(${i},this.value)"><button class="qty-btn" onclick="changeClientQty(${i},1)">+</button></div></div>`; }).join(''); document.getElementById('client-cart-total').innerText = t.toLocaleString() + " so'm"; } function changeClientQty(i, d) { clientCart[i].qty += d; if (clientCart[i].qty <= 0) clientCart.splice(i, 1); updateClientCartUI(); } function updateClientQtyManual(i, v) { let q = parseFloat(v); if (q <= 0) clientCart.splice(i, 1); else clientCart[i].qty = q; updateClientCartUI(); } function toggleClientCart() { document.getElementById('client-cart-panel').classList.toggle('open'); } function getLocation() { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(p => { clientLoc = { lat: p.coords.latitude, lng: p.coords.longitude }; document.getElementById('loc-status').style.display = 'block'; }, () => myAlert("Ruxsat bering!")); } else myAlert("Ishlamaydi"); }
        function submitOrderFinal() { const cName = document.getElementById('client-name').value; const cPhone = document.getElementById('client-phone').value; const totalSum = clientCart.reduce((a, b) => a + b.qty * b.sell, 0); if (!cName || !cPhone) return myAlert("Ism va Telefon kiriting!"); if (clientCart.length === 0) return myAlert("Savat bo'sh!"); const o = { id: Date.now(), client: cName, phone: cPhone, items: [...clientCart], total: totalSum, date: new Date().toLocaleString(), loc: clientLoc }; let destShop = shopParam ? shopParam : currentUserPhone; if(destShop) { db.ref("saas_dokonlar/" + destShop + "/ORDERS").once("value", snap => { let currentOrders = snap.val() || []; if(!Array.isArray(currentOrders)) currentOrders = Object.values(currentOrders); currentOrders.push(o); db.ref("saas_dokonlar/" + destShop + "/ORDERS").set(currentOrders).then(() => { if (dokonSozlamalar.tg_bot_token && dokonSozlamalar.tg_chat_id) { let msg = `üõí <b>YANGI ONLINE BUYURTMA!</b>\n\nüë§ Mijoz: <b>${cName}</b>\nüìû Tel: +${cPhone}\n\nüõç <b>Buyurtma ro'yxati:</b>\n`; clientCart.forEach(c => { msg += `‚ñ´Ô∏è ${c.name} x${c.qty} = ${(c.qty * c.sell).toLocaleString()} so'm\n`; }); msg += `\nüí∞ <b>JAMI SUMMA: ${totalSum.toLocaleString()} so'm</b>`; if (clientLoc) msg += `\n\nüìç <a href="https://maps.google.com/?q=$${clientLoc.lat},${clientLoc.lng}">Xaritada ko'rish</a>`; fetch(`https://api.telegram.org/bot${dokonSozlamalar.tg_bot_token}/sendMessage`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ chat_id: dokonSozlamalar.tg_chat_id, text: msg, parse_mode: 'HTML' }) }).catch(e => console.log(e)); } clientCart = []; clientLoc = null; document.getElementById('client-name').value = ''; document.getElementById('client-phone').value = ''; document.getElementById('loc-status').style.display = 'none'; updateClientCartUI(); closeModal('modal-client-check'); toggleClientCart(); if(!shopParam) saveToCloud(); myAlert("Buyurtma muvaffaqiyatli yuborildi! ‚úÖ\nSotuvchi tez orada bog'lanadi."); }); }); } }
        
        function startScanner(m) { document.getElementById('scanner-modal').style.display = 'flex'; if (html5QrCode) { try { html5QrCode.stop().then(() => { html5QrCode.clear(); }); } catch (e) {} } html5QrCode = new Html5Qrcode("reader"); scanLock = false; html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (d) => { if (scanLock) return; scanLock = true; if (m === 'ombor') { stopScanner(); document.getElementById('p-code').value = d; } else { const p = DB.find(x => { const codes = x.code ? x.code.split(',').map(c => c.trim().toLowerCase()) : []; return codes.includes(d.toLowerCase()); }); if (p) addToCart(p.id); else myAlert("Topilmadi!"); setTimeout(() => { scanLock = false; }, 1500); } }, (e) => {}).catch(e => console.log(e)); } function stopScanner() { if (html5QrCode) html5QrCode.stop().then(() => { html5QrCode.clear(); document.getElementById('scanner-modal').style.display = 'none'; }).catch(() => { document.getElementById('scanner-modal').style.display = 'none'; }); else document.getElementById('scanner-modal').style.display = 'none'; }
    </script>
</body>
</html>